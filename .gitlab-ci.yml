stages:
  - prepare
  - backend-test
  - frontend-build
  - images

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip/
    - frontend/node_modules/

before_script:
  - echo "CI job running on $CI_RUNNER_DESCRIPTION"

backend-test:
  image: python:3.11
  stage: backend-test
  services: []
  script:
    - python -m pip install --upgrade pip
    - python -m pip install -r backend/requirements.txt
    - python -m pip install pytest
    - python -m pytest -q || true
  artifacts:
    when: always
    paths:
      - backend/

frontend-build:
  image: node:18
  stage: frontend-build
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/build/

build-images:
  image: docker:24-dind
  stage: images
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - apk add --no-cache curl
    - curl -LO https://github.com/containerd/nerdctl/releases/download/v1.7.5/nerdctl-1.7.5-linux-amd64.tar.gz
    - tar xzf nerdctl-1.7.5-linux-amd64.tar.gz -C /usr/local/bin
    - nerdctl version || true
    - make build-all || true
  when: manual
